# proc_creation_win_powershell_malicious_cmdlets

## Title
Malicious PowerShell Commandlets - ProcessCreation

## ID
02030f2f-6199-49ec-b258-ea71b07e03dc

## Author
Nasreddine Bencherchali (Nextron Systems)

## Date
2023-01-02

## Tags
attack.execution, attack.discovery, attack.t1482, attack.t1087, attack.t1087.001, attack.t1087.002, attack.t1069.001, attack.t1069.002, attack.t1069, attack.t1059.001

## Description
Detects Commandlet names from well-known PowerShell exploitation frameworks

## References
https://adsecurity.org/?p=2921
https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries
https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1
https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1
https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1
https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1
https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/
https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/
https://github.com/calebstewart/CVE-2021-1675
https://github.com/BloodHoundAD/BloodHound/blob/0927441f67161cc6dc08a53c63ceb8e333f55874/Collectors/AzureHound.ps1
https://bloodhound.readthedocs.io/en/latest/data-collection/azurehound.html
https://github.com/HarmJ0y/DAMP
https://github.com/samratashok/nishang
https://github.com/DarkCoderSc/PowerRunAsSystem/
https://github.com/besimorhino/powercat
https://github.com/Kevin-Robertson/Powermad
https://github.com/adrecon/ADRecon
https://github.com/adrecon/AzureADRecon

## False Positives
Unknown

## SentinelOne Query
```
EventType = "Process Creation" AND (EndpointOS = "windows" AND (TgtProcCmdLine containsCIS "Add-Exfiltration" OR TgtProcCmdLine containsCIS "Add-Persistence" OR TgtProcCmdLine containsCIS "Add-RegBackdoor" OR TgtProcCmdLine containsCIS "Add-RemoteRegBackdoor" OR TgtProcCmdLine containsCIS "Add-ScrnSaveBackdoor" OR TgtProcCmdLine containsCIS "Check-VM" OR TgtProcCmdLine containsCIS "ConvertTo-Rc4ByteStream" OR TgtProcCmdLine containsCIS "Decrypt-Hash" OR TgtProcCmdLine containsCIS "Disable-ADIDNSNode" OR TgtProcCmdLine containsCIS "Disable-MachineAccount" OR TgtProcCmdLine containsCIS "Do-Exfiltration" OR TgtProcCmdLine containsCIS "Enable-ADIDNSNode" OR TgtProcCmdLine containsCIS "Enable-MachineAccount" OR TgtProcCmdLine containsCIS "Enabled-DuplicateToken" OR TgtProcCmdLine containsCIS "Exploit-Jboss" OR TgtProcCmdLine containsCIS "Export-ADR" OR TgtProcCmdLine containsCIS "Export-ADRCSV" OR TgtProcCmdLine containsCIS "Export-ADRExcel" OR TgtProcCmdLine containsCIS "Export-ADRHTML" OR TgtProcCmdLine containsCIS "Export-ADRJSON" OR TgtProcCmdLine containsCIS "Export-ADRXML" OR TgtProcCmdLine containsCIS "Find-Fruit" OR TgtProcCmdLine containsCIS "Find-GPOLocation" OR TgtProcCmdLine containsCIS "Find-TrustedDocuments" OR TgtProcCmdLine containsCIS "Get-ADIDNS" OR TgtProcCmdLine containsCIS "Get-ApplicationHost" OR TgtProcCmdLine containsCIS "Get-ChromeDump" OR TgtProcCmdLine containsCIS "Get-ClipboardContents" OR TgtProcCmdLine containsCIS "Get-FoxDump" OR TgtProcCmdLine containsCIS "Get-GPPPassword" OR TgtProcCmdLine containsCIS "Get-IndexedItem" OR TgtProcCmdLine containsCIS "Get-KerberosAESKey" OR TgtProcCmdLine containsCIS "Get-Keystrokes" OR TgtProcCmdLine containsCIS "Get-LSASecret" OR TgtProcCmdLine containsCIS "Get-MachineAccountAttribute" OR TgtProcCmdLine containsCIS "Get-MachineAccountCreator" OR TgtProcCmdLine containsCIS "Get-PassHashes" OR TgtProcCmdLine containsCIS "Get-RegAlwaysInstallElevated" OR TgtProcCmdLine containsCIS "Get-RegAutoLogon" OR TgtProcCmdLine containsCIS "Get-RemoteBootKey" OR TgtProcCmdLine containsCIS "Get-RemoteCachedCredential" OR TgtProcCmdLine containsCIS "Get-RemoteLocalAccountHash" OR TgtProcCmdLine containsCIS "Get-RemoteLSAKey" OR TgtProcCmdLine containsCIS "Get-RemoteMachineAccountHash" OR TgtProcCmdLine containsCIS "Get-RemoteNLKMKey" OR TgtProcCmdLine containsCIS "Get-RickAstley" OR TgtProcCmdLine containsCIS "Get-Screenshot" OR TgtProcCmdLine containsCIS "Get-SecurityPackages" OR TgtProcCmdLine containsCIS "Get-ServiceFilePermission" OR TgtProcCmdLine containsCIS "Get-ServicePermission" OR TgtProcCmdLine containsCIS "Get-ServiceUnquoted" OR TgtProcCmdLine containsCIS "Get-SiteListPassword" OR TgtProcCmdLine containsCIS "Get-System" OR TgtProcCmdLine containsCIS "Get-TimedScreenshot" OR TgtProcCmdLine containsCIS "Get-UnattendedInstallFile" OR TgtProcCmdLine containsCIS "Get-Unconstrained" OR TgtProcCmdLine containsCIS "Get-USBKeystrokes" OR TgtProcCmdLine containsCIS "Get-VaultCredential" OR TgtProcCmdLine containsCIS "Get-VulnAutoRun" OR TgtProcCmdLine containsCIS "Get-VulnSchTask" OR TgtProcCmdLine containsCIS "Grant-ADIDNSPermission" OR TgtProcCmdLine containsCIS "Gupt-Backdoor" OR TgtProcCmdLine containsCIS "HTTP-Login" OR TgtProcCmdLine containsCIS "Install-ServiceBinary" OR TgtProcCmdLine containsCIS "Install-SSP" OR TgtProcCmdLine containsCIS "Invoke-ACLScanner" OR TgtProcCmdLine containsCIS "Invoke-ADRecon" OR TgtProcCmdLine containsCIS "Invoke-ADSBackdoor" OR TgtProcCmdLine containsCIS "Invoke-AgentSmith" OR TgtProcCmdLine containsCIS "Invoke-AllChecks" OR TgtProcCmdLine containsCIS "Invoke-ARPScan" OR TgtProcCmdLine containsCIS "Invoke-AzureHound" OR TgtProcCmdLine containsCIS "Invoke-BackdoorLNK" OR TgtProcCmdLine containsCIS "Invoke-BadPotato" OR TgtProcCmdLine containsCIS "Invoke-BetterSafetyKatz" OR TgtProcCmdLine containsCIS "Invoke-BypassUAC" OR TgtProcCmdLine containsCIS "Invoke-Carbuncle" OR TgtProcCmdLine containsCIS "Invoke-Certify" OR TgtProcCmdLine containsCIS "Invoke-ConPtyShell" OR TgtProcCmdLine containsCIS "Invoke-CredentialInjection" OR TgtProcCmdLine containsCIS "Invoke-DAFT" OR TgtProcCmdLine containsCIS "Invoke-DCSync" OR TgtProcCmdLine containsCIS "Invoke-DinvokeKatz" OR TgtProcCmdLine containsCIS "Invoke-DllInjection" OR TgtProcCmdLine containsCIS "Invoke-DNSUpdate" OR TgtProcCmdLine containsCIS "Invoke-DomainPasswordSpray" OR TgtProcCmdLine containsCIS "Invoke-DowngradeAccount" OR TgtProcCmdLine containsCIS "Invoke-EgressCheck" OR TgtProcCmdLine containsCIS "Invoke-Eyewitness" OR TgtProcCmdLine containsCIS "Invoke-FakeLogonScreen" OR TgtProcCmdLine containsCIS "Invoke-Farmer" OR TgtProcCmdLine containsCIS "Invoke-Get-RBCD-Threaded" OR TgtProcCmdLine containsCIS "Invoke-Gopher" OR TgtProcCmdLine containsCIS "Invoke-Grouper" OR TgtProcCmdLine containsCIS "Invoke-HandleKatz" OR TgtProcCmdLine containsCIS "Invoke-ImpersonatedProcess" OR TgtProcCmdLine containsCIS "Invoke-ImpersonateSystem" OR TgtProcCmdLine containsCIS "Invoke-InteractiveSystemPowerShell" OR TgtProcCmdLine containsCIS "Invoke-Internalmonologue" OR TgtProcCmdLine containsCIS "Invoke-Inveigh" OR TgtProcCmdLine containsCIS "Invoke-InveighRelay" OR TgtProcCmdLine containsCIS "Invoke-KrbRelay" OR TgtProcCmdLine containsCIS "Invoke-LdapSignCheck" OR TgtProcCmdLine containsCIS "Invoke-Lockless" OR TgtProcCmdLine containsCIS "Invoke-MalSCCM" OR TgtProcCmdLine containsCIS "Invoke-Mimikatz" OR TgtProcCmdLine containsCIS "Invoke-Mimikittenz" OR TgtProcCmdLine containsCIS "Invoke-MITM6" OR TgtProcCmdLine containsCIS "Invoke-NanoDump" OR TgtProcCmdLine containsCIS "Invoke-NetRipper" OR TgtProcCmdLine containsCIS "Invoke-Nightmare" OR TgtProcCmdLine containsCIS "Invoke-NinjaCopy" OR TgtProcCmdLine containsCIS "Invoke-OfficeScrape" OR TgtProcCmdLine containsCIS "Invoke-OxidResolver" OR TgtProcCmdLine containsCIS "Invoke-P0wnedshell" OR TgtProcCmdLine containsCIS "Invoke-Paranoia" OR TgtProcCmdLine containsCIS "Invoke-PortScan" OR TgtProcCmdLine containsCIS "Invoke-PoshRatHttp" OR TgtProcCmdLine containsCIS "Invoke-PostExfil" OR TgtProcCmdLine containsCIS "Invoke-PowerDump" OR TgtProcCmdLine containsCIS "Invoke-PowerShellTCP" OR TgtProcCmdLine containsCIS "Invoke-PowerShellWMI" OR TgtProcCmdLine containsCIS "Invoke-PPLDump" OR TgtProcCmdLine containsCIS "Invoke-PsExec" OR TgtProcCmdLine containsCIS "Invoke-PSInject" OR TgtProcCmdLine containsCIS "Invoke-PsUaCme" OR TgtProcCmdLine containsCIS "Invoke-ReflectivePEInjection" OR TgtProcCmdLine containsCIS "Invoke-ReverseDNSLookup" OR TgtProcCmdLine containsCIS "Invoke-Rubeus" OR TgtProcCmdLine containsCIS "Invoke-RunAs" OR TgtProcCmdLine containsCIS "Invoke-SafetyKatz" OR TgtProcCmdLine containsCIS "Invoke-SauronEye" OR TgtProcCmdLine containsCIS "Invoke-SCShell" OR TgtProcCmdLine containsCIS "Invoke-Seatbelt" OR TgtProcCmdLine containsCIS "Invoke-ServiceAbuse" OR TgtProcCmdLine containsCIS "Invoke-ShadowSpray" OR TgtProcCmdLine containsCIS "Invoke-Sharp" OR TgtProcCmdLine containsCIS "Invoke-Shellcode" OR TgtProcCmdLine containsCIS "Invoke-SMBScanner" OR TgtProcCmdLine containsCIS "Invoke-Snaffler" OR TgtProcCmdLine containsCIS "Invoke-Spoolsample" OR TgtProcCmdLine containsCIS "Invoke-SpraySinglePassword" OR TgtProcCmdLine containsCIS "Invoke-SSHCommand" OR TgtProcCmdLine containsCIS "Invoke-StandIn" OR TgtProcCmdLine containsCIS "Invoke-StickyNotesExtract" OR TgtProcCmdLine containsCIS "Invoke-SystemCommand" OR TgtProcCmdLine containsCIS "Invoke-Tasksbackdoor" OR TgtProcCmdLine containsCIS "Invoke-Tater" OR TgtProcCmdLine containsCIS "Invoke-Thunderfox" OR TgtProcCmdLine containsCIS "Invoke-ThunderStruck" OR TgtProcCmdLine containsCIS "Invoke-TokenManipulation" OR TgtProcCmdLine containsCIS "Invoke-Tokenvator" OR TgtProcCmdLine containsCIS "Invoke-TotalExec" OR TgtProcCmdLine containsCIS "Invoke-UrbanBishop" OR TgtProcCmdLine containsCIS "Invoke-UserHunter" OR TgtProcCmdLine containsCIS "Invoke-VoiceTroll" OR TgtProcCmdLine containsCIS "Invoke-Whisker" OR TgtProcCmdLine containsCIS "Invoke-WinEnum" OR TgtProcCmdLine containsCIS "Invoke-winPEAS" OR TgtProcCmdLine containsCIS "Invoke-WireTap" OR TgtProcCmdLine containsCIS "Invoke-WmiCommand" OR TgtProcCmdLine containsCIS "Invoke-WMIExec" OR TgtProcCmdLine containsCIS "Invoke-WScriptBypassUAC" OR TgtProcCmdLine containsCIS "Invoke-Zerologon" OR TgtProcCmdLine containsCIS "MailRaider" OR TgtProcCmdLine containsCIS "New-ADIDNSNode" OR TgtProcCmdLine containsCIS "New-DNSRecordArray" OR TgtProcCmdLine containsCIS "New-HoneyHash" OR TgtProcCmdLine containsCIS "New-InMemoryModule" OR TgtProcCmdLine containsCIS "New-MachineAccount" OR TgtProcCmdLine containsCIS "New-SOASerialNumberArray" OR TgtProcCmdLine containsCIS "Out-Minidump" OR TgtProcCmdLine containsCIS "Port-Scan" OR TgtProcCmdLine containsCIS "PowerBreach" OR TgtProcCmdLine containsCIS "powercat " OR TgtProcCmdLine containsCIS "PowerUp" OR TgtProcCmdLine containsCIS "PowerView" OR TgtProcCmdLine containsCIS "Remove-ADIDNSNode" OR TgtProcCmdLine containsCIS "Remove-MachineAccount" OR TgtProcCmdLine containsCIS "Remove-Update" OR TgtProcCmdLine containsCIS "Rename-ADIDNSNode" OR TgtProcCmdLine containsCIS "Revoke-ADIDNSPermission" OR TgtProcCmdLine containsCIS "Set-ADIDNSNode" OR TgtProcCmdLine containsCIS "Set-MacAttribute" OR TgtProcCmdLine containsCIS "Set-MachineAccountAttribute" OR TgtProcCmdLine containsCIS "Set-Wallpaper" OR TgtProcCmdLine containsCIS "Show-TargetScreen" OR TgtProcCmdLine containsCIS "Start-CaptureServer" OR TgtProcCmdLine containsCIS "Start-Dnscat2" OR TgtProcCmdLine containsCIS "Start-WebcamRecorder" OR TgtProcCmdLine containsCIS "VolumeShadowCopyTools"))

```